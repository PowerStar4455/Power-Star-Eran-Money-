<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Star Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background:#0f172a; color:white; font-family:sans-serif; padding:15px; }
        .card { background:#1e293b; border-radius:12px; padding:15px; margin-bottom:15px; border:1px solid #334155; }
        .w-item { background:#0b0f1a; padding:12px; border-radius:10px; margin-top:10px; border-left:4px solid #fbbf24; font-size:12px; line-height:1.6; }
        input, select { width:100%; padding:12px; margin:5px 0; background:#0f172a; border:1px solid #334155; color:white; border-radius:8px; }
        .btn { width:100%; padding:14px; background:#fbbf24; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
    </style>
</head>
<body>
    <h2 style="text-align:center; color:#fbbf24;">ADMIN CONTROL</h2>
    
    <div class="card">
        <h3>Quick Send (Salary/Bonus)</h3>
        <input type="number" id="ph" placeholder="User Number">
        <input type="number" id="am" placeholder="Amount">
        <select id="ty"><option value="SALARY">Weekly Salary</option><option value="BONUS">Bonus</option></select>
        <button class="btn" onclick="sendMoney()">Send Funds</button>
    </div>

    <div class="card">
        <h3>Pending Withdrawals</h3>
        <div id="list">Loading...</div>
    </div>

<script>
    const API = "https://sheetdb.io/api/v1/lcnr1ekbbyn58";

    async function sendMoney() {
        const p = document.getElementById('ph').value, a = document.getElementById('am').value, t = document.getElementById('ty').value;
        const res = await fetch(`${API}/search?number=${p}`);
        const data = await res.json();
        const u = data.find(x => !x.row_type);
        if(u) {
            await fetch(`${API}/number/${p}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({balance: parseFloat(u.balance) + parseFloat(a)}) });
            await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({number:p, row_type:t, w_amount:a, status:'success', date:new Date().toLocaleString()}) });
            Swal.fire("Done!", "Funds Sent", "success");
        }
    }

    async function loadW() {
        const r = await fetch(`${API}/search?row_type=WITHDRAWAL&status=pending`);
        const withdrawals = await r.json();
        const list = document.getElementById('list');
        
        if(withdrawals.length === 0) { list.innerHTML = "No pending requests."; return; }

        let html = '';
        for(let w of withdrawals) {
            // Har user ki binding detail fetch karna taake account no show ho
            const br = await fetch(`${API}/search?number=${w.number}&row_type=BINDING`);
            const bd = await br.json();
            const b = bd[bd.length-1] || {};
            
            html += `
                <div class="w-item">
                    <b>Rs. ${w.w_amount}</b> to ${w.number}<br>
                    NAME: ${b.acc_title || 'N/A'}<br>
                    ACC: ${b.acc_number || 'N/A'} (${b.wallet_name || 'N/A'})<br>
                    <button onclick="update('${w.number}','approved')" style="background:#10b981; color:white; border:none; padding:8px; border-radius:5px; margin-top:5px; cursor:pointer;">Approve</button>
                </div>`;
        }
        list.innerHTML = html;
    }

    async function update(num, status) {
        await fetch(`${API}/number/${num}?status=pending&row_type=WITHDRAWAL`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:status}) });
        location.reload();
    }
    window.onload = loadW;
</script>
</body>
</html>
