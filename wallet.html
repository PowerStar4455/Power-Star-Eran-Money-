<script>
    const API = "https://sheetdb.io/api/v1/lcnr1ekbbyn58";
    let user = JSON.parse(localStorage.getItem('power_star_user'));

    window.onload = () => { 
        if(!user) {
            location.href="index.html"; 
        } else {
            refreshWallet(); 
        }
    };

    async function refreshWallet() {
        try {
            // API call to get all rows for this user
            const r = await fetch(`${API}/search?number=${user.number}`);
            const data = await r.json();
            
            if(!Array.isArray(data)) return;

            // 1. BALANCE REVIEW: (Amount ab update hogi)
            const mainRow = data.find(x => !x.row_type || x.row_type === "");
            if(mainRow) {
                const liveBal = parseFloat(mainRow.balance || 0);
                document.getElementById('user-balance').innerText = "Rs. " + liveBal.toFixed(2);
                document.getElementById('claimed-comm').innerText = "Rs. " + (mainRow.claimed_comm || 0);
                document.getElementById('total-profit').innerText = "Rs. " + (liveBal + parseFloat(mainRow.claimed_comm || 0)).toFixed(2);
                
                // Save live balance to memory
                user.balance = liveBal;
                localStorage.setItem('power_star_user', JSON.stringify(user));
            }

            // 2. CARD REVIEW: (User details ab Card par nazar aayengi)
            const bindRow = data.find(x => x.row_type === "BINDING");
            if(bindRow && bindRow.acc_number) {
                // Form hide karo
                document.getElementById('binding-form').style.display = 'none';
                document.getElementById('bound-card').style.display = 'block';
                
                // Direct mapping from Column M, N, O
                document.getElementById('card-method').innerText = (bindRow.wallet_name || "METHOD").toUpperCase();
                document.getElementById('card-number').innerText = bindRow.acc_number;
                document.getElementById('card-title').innerText = (bindRow.acc_title || "USER NAME").toUpperCase();
                
                window.isAccountBound = true;
                localStorage.setItem('ps_bound', 'true'); // Persistent lock
            }

            // 3. HISTORY REVIEW: (Withdrawal list show hogi)
            const logs = data.filter(x => x.row_type === "WITHDRAWAL");
            const hContainer = document.getElementById('history-container');
            if(logs.length > 0) {
                hContainer.innerHTML = logs.reverse().map(l => `
                    <div class="hist-item">
                        <div><b>Rs. ${l.w_amount}</b><br><small style="opacity:0.5;">${l.date}</small></div>
                        <div style="text-align:right;"><span style="color:${l.status === 'pending' ? '#fbbf24' : '#10b981'}; font-weight:bold;">${l.status.toUpperCase()}</span></div>
                    </div>`).join('');
            } else {
                hContainer.innerHTML = "<p style='text-align:center; font-size:11px; opacity:0.5;'>No history found.</p>";
            }

        } catch(e) { console.error("Sync Review Error"); }
    }

    async function handleWithdraw() {
        const val = document.getElementById('w-amount').value;
        const amt = parseFloat(val);

        // Security check for binding
        if(!window.isAccountBound && localStorage.getItem('ps_bound') !== 'true') {
            return Swal.fire("Locked", "Please bind your account first!", "warning");
        }
        
        if(amt < 525 || isNaN(amt)) return Swal.fire("Error", "Min Withdrawal: Rs. 525", "error");
        
        // Final Balance Check before PATCH
        if(amt > parseFloat(user.balance)) return Swal.fire("Insufficient Funds", "Your balance is low", "error");

        Swal.fire({title: 'Processing...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

        try {
            // Step 1: PATCH (Balance kam karo)
            const patchRes = await fetch(`${API}/number/${user.number}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ balance: parseFloat(user.balance) - amt })
            });

            if(patchRes.ok) {
                // Step 2: POST (History create karo)
                await fetch(API, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        number: user.number, 
                        row_type: "WITHDRAWAL", 
                        w_amount: amt, 
                        status: "pending", 
                        date: new Date().toLocaleString() 
                    })
                });
                
                Swal.fire("Success", "Withdrawal Submitted!", "success").then(() => {
                    location.reload(); // Hard refresh to sync all data
                });
            }
        } catch(e) { Swal.fire("Error", "Server busy", "error"); }
    }

    function logout() { localStorage.clear(); location.href="index.html"; }
</script>
