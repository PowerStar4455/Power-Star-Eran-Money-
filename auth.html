<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Power Star | Professional Secure Auth</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        body { background: #0f172a; color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 15px; }
        .auth-box { background: #1e293b; width: 100%; max-width: 400px; border-radius: 25px; padding: 30px 20px; border: 1px solid #fbbf24; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        h2 { color: #fbbf24; text-align: center; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 1px; font-size: 22px; }
        
        .group { position: relative; margin-bottom: 18px; width: 100%; }
        
        .prefix { 
            position: absolute; 
            left: 12px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #fbbf24; 
            font-weight: bold; 
            border-right: 2px solid #334155; 
            padding-right: 8px;
            font-size: 15px;
            z-index: 10;
            pointer-events: none;
        }
        
        input { 
            width: 100%; 
            background: #0f172a; 
            border: 1.5px solid #334155; 
            border-radius: 15px; 
            padding: 15px; 
            color: white; 
            font-size: 15px; 
            outline: none; 
            transition: 0.3s; 
        }
        
        input:focus { 
            border-color: #fbbf24; 
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); 
        }
        
        input::placeholder { color: #64748b; }
        
        .num-in { padding-left: 60px !important; }
        
        .eye { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #94a3b8; 
            cursor: pointer; 
            padding: 5px;
            z-index: 10;
        }
        .eye:hover { color: #fbbf24; }
        
        .terms-box { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin: 15px 0; 
            font-size: 13px; 
            color: #94a3b8; 
        }
        .terms-box input { 
            width: 18px; 
            height: 18px; 
            cursor: pointer; 
            accent-color: #fbbf24; 
        }
        .terms-box label { cursor: pointer; }
        
        .device-info { 
            background: rgba(15, 23, 42, 0.7); 
            padding: 10px; 
            border-radius: 12px; 
            border: 1px dashed #334155; 
            margin-top: 15px; 
            font-size: 11px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        button { 
            width: 100%; 
            padding: 16px; 
            background: #fbbf24; 
            color: black; 
            font-weight: 800; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: 0.3s; 
            text-transform: uppercase; 
        }
        button:hover { 
            background: #f59e0b; 
            transform: translateY(-2px); 
        }
        button:disabled { 
            background: #475569; 
            cursor: not-allowed; 
            transform: none; 
        }
        
        .switch { 
            text-align: center; 
            margin-top: 20px; 
            font-size: 14px; 
            color: #94a3b8; 
        }
        .switch span { 
            color: #fbbf24; 
            font-weight: bold; 
            cursor: pointer; 
            text-decoration: underline; 
        }
        
        .hidden { display: none; }
        
        .password-strength { 
            height: 4px; 
            border-radius: 2px; 
            margin-top: 5px; 
            transition: 0.3s; 
        }
        .strength-weak { background: #ef4444; width: 33%; }
        .strength-medium { background: #f59e0b; width: 66%; }
        .strength-strong { background: #10b981; width: 100%; }
    </style>
</head>
<body>

    <div class="auth-box">
        <!-- LOGIN FORM -->
        <div id="l-form">
            <h2><i class="fas fa-fingerprint"></i> Secure Login</h2>
            
            <div class="group">
                <span class="prefix">+92</span>
                <input type="tel" id="l-num" class="num-in" placeholder="3001234567" maxlength="10">
            </div>
            
            <div class="group">
                <input type="password" id="l-pass" placeholder="Enter Password">
                <i class="fas fa-eye eye" onclick="toggleP('l-pass')"></i>
            </div>
            
            <button onclick="doLogin()" id="login-btn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <p class="switch">New to Power Star? <span onclick="swap()">Create Account</span></p>
        </div>

        <!-- REGISTER FORM -->
        <div id="r-form" class="hidden">
            <h2><i class="fas fa-user-shield"></i> Join Power Star</h2>
            
            <div class="group">
                <input type="text" id="r-name" placeholder="Full Name">
            </div>
            
            <div class="group">
                <span class="prefix">+92</span>
                <input type="tel" id="r-num" class="num-in" placeholder="3001234567" maxlength="10">
            </div>
            
            <div class="group">
                <input type="password" id="r-pass" placeholder="Create Password (min 6 chars)" oninput="checkPasswordStrength()">
                <i class="fas fa-eye eye" onclick="toggleP('r-pass')"></i>
                <div id="pwd-strength" class="password-strength"></div>
            </div>
            
            <div class="group">
                <input type="text" id="r-ref" placeholder="Referral Code (Optional)" style="text-transform: uppercase;">
            </div>
            
            <div class="terms-box">
                <input type="checkbox" id="terms-chk">
                <label for="terms-chk">I agree to <b style="color: #fbbf24;">Terms & Conditions</b></label>
            </div>

            <button id="reg-btn" onclick="doRegister()">
                <i class="fas fa-user-plus"></i> Register Now
            </button>
            
            <p class="switch">Already a member? <span onclick="swap()">Login here</span></p>
        </div>

        <div class="device-info">
            <span>üîê DEVICE: <span id="did-text">********</span></span>
            <i class="fas fa-eye" style="cursor:pointer; color:#fbbf24;" onclick="toggleDID()"></i>
        </div>
    </div>

    <script>
// Configuration constants
const CONFIG = {
  SHEET_NAME: "Power_Star_Users",
  SECURITY_KEY: "POWER_STAR_786_SECURE",
  TIMEZONE: "Asia/Karachi",
  DATE_FORMAT: "yyyy-MM-dd HH:mm:ss",
  DEFAULT_BALANCE: 0,
  DEFAULT_STATUS: "active"
};

// Column indices for better maintainability
const COLUMNS = {
  DATE: 0,
  NUMBER: 1,
  NAME: 2,
  PASSWORD: 3,
  BALANCE: 4,
  USER_ID: 5,
  REFER_BY: 6,
  STATUS: 7,
  DEVICE_ID: 8
};

/**
 * GET request handler - Retrieve all users
 * @param {Object} e - Event parameter
 * @returns {TextOutput} JSON response with user data
 */
function doGet(e) {
  try {
    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();
    const users = [];
    
    // Skip header row and process data
    for (let i = 1; i < data.length; i++) {
      users.push({
        date: data[i][COLUMNS.DATE],
        number: data[i][COLUMNS.NUMBER],
        name: data[i][COLUMNS.NAME],
        // Never return password in GET requests
        balance: data[i][COLUMNS.BALANCE],
        user_id: data[i][COLUMNS.USER_ID],
        refer_by: data[i][COLUMNS.REFER_BY],
        status: data[i][COLUMNS.STATUS],
        device_id: data[i][COLUMNS.DEVICE_ID] ? "registered" : "not_registered"
      });
    }
    
    return createJsonResponse({ success: true, data: users });
    
  } catch (error) {
    Logger.log('Error in doGet: ' + error.toString());
    return createJsonResponse({ 
      success: false, 
      message: "Failed to retrieve data",
      error: error.toString() 
    });
  }
}

/**
 * POST request handler - Register new user
 * @param {Object} e - Event parameter with POST data
 * @returns {TextOutput} JSON response
 */
function doPost(e) {
  try {
    // Parse request data
    const data = JSON.parse(e.postData.contents);
    
    // Security validation
    if (!validateSecurityKey(data.key)) {
      return createJsonResponse({ 
        success: false, 
        message: "Unauthorized access" 
      }, 401);
    }
    
    // Input validation
    const validationResult = validateUserInput(data);
    if (!validationResult.valid) {
      return createJsonResponse({ 
        success: false, 
        message: validationResult.message 
      }, 400);
    }
    
    const sheet = getSheet();
    
    // Check for duplicate phone number
    if (isPhoneNumberExists(sheet, data.number)) {
      return createJsonResponse({ 
        success: false, 
        message: "Phone number already registered" 
      }, 409);
    }
    
    // Check for duplicate user_id
    if (isUserIdExists(sheet, data.user_id)) {
      return createJsonResponse({ 
        success: false, 
        message: "User ID already exists" 
      }, 409);
    }
    
    // One device per account policy
    if (data.device_id && isDeviceIdExists(sheet, data.device_id)) {
      return createJsonResponse({ 
        success: false, 
        message: "This device is already registered with another account" 
      }, 409);
    }
    
    // Hash password before storing
    const hashedPassword = hashPassword(data.password);
    
    // Get current timestamp
    const currentDate = getCurrentTimestamp();
    
    // Prepare user data
    const newUser = [
      currentDate,                          // A: date
      sanitizeInput(data.number),           // B: number
      sanitizeInput(data.name),             // C: name
      hashedPassword,                       // D: password (hashed)
      data.balance || CONFIG.DEFAULT_BALANCE, // E: balance
      sanitizeInput(data.user_id),          // F: user_id
      sanitizeInput(data.referral) || "",   // G: refer_by
      data.status || CONFIG.DEFAULT_STATUS, // H: status
      sanitizeInput(data.device_id) || ""   // I: device_id
    ];
    
    // Add new user to sheet
    sheet.appendRow(newUser);
    
    Logger.log('New user registered: ' + data.user_id);
    
    return createJsonResponse({ 
      success: true, 
      message: "User registered successfully",
      user_id: data.user_id
    });
    
  } catch (error) {
    Logger.log('Error in doPost: ' + error.toString());
    return createJsonResponse({ 
      success: false, 
      message: "Registration failed",
      error: error.toString() 
    }, 500);
  }
}

/**
 * Login verification function
 * @param {Object} e - Event parameter with login data
 * @returns {TextOutput} JSON response
 */
function doLogin(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    // Security validation
    if (!validateSecurityKey(data.key)) {
      return createJsonResponse({ 
        success: false, 
        message: "Unauthorized access" 
      }, 401);
    }
    
    const sheet = getSheet();
    const allData = sheet.getDataRange().getValues();
    
    // Find user by phone number
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][COLUMNS.NUMBER] === data.number) {
        const storedHashedPassword = allData[i][COLUMNS.PASSWORD];
        
        // Verify password
        if (verifyPassword(data.password, storedHashedPassword)) {
          
          // Check device_id for one device policy
          const storedDeviceId = allData[i][COLUMNS.DEVICE_ID];
          
          if (storedDeviceId && storedDeviceId !== data.device_id) {
            return createJsonResponse({ 
              success: false, 
              message: "Account is registered on another device" 
            }, 403);
          }
          
          // Update device_id if not set
          if (!storedDeviceId && data.device_id) {
            sheet.getRange(i + 1, COLUMNS.DEVICE_ID + 1).setValue(data.device_id);
          }
          
          return createJsonResponse({ 
            success: true, 
            message: "Login successful",
            user: {
              name: allData[i][COLUMNS.NAME],
              user_id: allData[i][COLUMNS.USER_ID],
              balance: allData[i][COLUMNS.BALANCE],
              status: allData[i][COLUMNS.STATUS]
            }
          });
        } else {
          return createJsonResponse({ 
            success: false, 
            message: "Invalid password" 
          }, 401);
        }
      }
    }
    
    return createJsonResponse({ 
      success: false, 
      message: "User not found" 
    }, 404);
    
  } catch (error) {
    Logger.log('Error in doLogin: ' + error.toString());
    return createJsonResponse({ 
      success: false, 
      message: "Login failed",
      error: error.toString() 
    }, 500);
  }
}

// ============== Helper Functions ==============

/**
 * Get the spreadsheet sheet
 */
function getSheet() {
  return SpreadsheetApp.getActiveSpreadsheet().getSheetByName(CONFIG.SHEET_NAME);
}

/**
 * Create JSON response
 */
function createJsonResponse(data, statusCode = 200) {
  const output = ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
  
  if (statusCode !== 200) {
    // Note: Apps Script doesn't support HTTP status codes, but we log them
    Logger.log('Response status: ' + statusCode);
  }
  
  return output;
}

/**
 * Validate security key
 */
function validateSecurityKey(key) {
  return key === CONFIG.SECURITY_KEY;
}

/**
 * Get current timestamp in Pakistan timezone
 */
function getCurrentTimestamp() {
  return Utilities.formatDate(
    new Date(), 
    CONFIG.TIMEZONE, 
    CONFIG.DATE_FORMAT
  );
}

/**
 * Validate user input
 */
function validateUserInput(data) {
  if (!data.number || data.number.trim() === "") {
    return { valid: false, message: "Phone number is required" };
  }
  
  if (!data.name || data.name.trim() === "") {
    return { valid: false, message: "Name is required" };
  }
  
  if (!data.password || data.password.length < 6) {
    return { valid: false, message: "Password must be at least 6 characters" };
  }
  
  if (!data.user_id || data.user_id.trim() === "") {
    return { valid: false, message: "User ID is required" };
  }
  
  if (!data.device_id || data.device_id.trim() === "") {
    return { valid: false, message: "Device ID is required" };
  }
  
  return { valid: true };
}

/**
 * Check if phone number already exists
 */
function isPhoneNumberExists(sheet, phoneNumber) {
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][COLUMNS.NUMBER] === phoneNumber) {
      return true;
    }
  }
  return false;
}

/**
 * Check if user_id already exists
 */
function isUserIdExists(sheet, userId) {
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][COLUMNS.USER_ID] === userId) {
      return true;
    }
  }
  return false;
}

/**
 * Check if device_id already exists
 */
function isDeviceIdExists(sheet, deviceId) {
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][COLUMNS.DEVICE_ID] === deviceId && data[i][COLUMNS.DEVICE_ID] !== "") {
      return true;
    }
  }
  return false;
}

/**
 * Hash password using SHA-256
 */
function hashPassword(password) {
  const rawHash = Utilities.computeDigest(
    Utilities.DigestAlgorithm.SHA_256,
    password,
    Utilities.Charset.UTF_8
  );
  
  // Convert to hex string
  let hashString = '';
  for (let i = 0; i < rawHash.length; i++) {
    const byte = rawHash[i];
    if (byte < 0) {
      hashString += ((byte + 256).toString(16)).padStart(2, '0');
    } else {
      hashString += (byte.toString(16)).padStart(2, '0');
    }
  }
  
  return hashString;
}

/**
 * Verify password against hash
 */
function verifyPassword(plainPassword, hashedPassword) {
  return hashPassword(plainPassword) === hashedPassword;
}

/**
 * Sanitize input to prevent injection
 */
function sanitizeInput(input) {
  if (typeof input !== 'string') {
    return input;
  }
  return input.trim().replace(/[<>]/g, '');
        }

    </script>
 </body>
    </html>
